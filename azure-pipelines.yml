trigger:
- master

pool:
  vmImage: 'Ubuntu-16.04'

# We build using a Docker container generated by GafferHQ/build
container: gafferhq/build:0.0.0

variables:
  ARNOLD_ROOT: $(System.DefaultWorkingDirectory)/arnoldRoot
  DELIGHT: $(System.DefaultWorkingDirectory)/3delight

steps:

- script: |
    echo ./config/travis/installDelight.sh
    echo ./config/azure/installArnold.sh
    echo ./config/travis/installDependencies.sh
  displayName: 'Install dependencies'
  env:
    ARNOLD_LOGIN: $(arnoldLogin)
    ARNOLD_PASSWORD: $(arnoldPassword)

#    scons -j 2 install ENV_VARS_TO_IMPORT=PATH DELIGHT_ROOT=$DELIGHT ARNOLD_ROOT=$ARNOLD_ROOT BUILD_CACHEDIR=sconsCache

- script: |
    g++ --version
    Xvfb :99 -screen 0 1280x1024x24 &
    metacity&
    echo XXX > test.txt
  displayName: 'Build'
  env:
    DISPLAY: :99.0

#    ./install/gaffer-*/bin/gaffer test

- script: |
    echo "All good"
    echo "Source version" $(Build.SourceVersion)
    echo "PR ID" $(System.PullRequest.PullRequestId)
    echo "PR Number" $(System.PullRequest.PullRequestNumber)
  displayName: 'Test'
  env:
    DISPLAY: :99.0
    USER: azureTestUser # ImageWriterTest requires $USER but by default Azure doesn't provide it

- task: PublishPipelineArtifact@0
  inputs:
    artifactName: 'testArtifact'
    targetPath: 'test.txt'

- script: |
    sudo yum install -y python2-dev
    sudo pip install azure-devops
    sudo pip install PyGithub
  displayName: "Build Bot Links"

